# Colab Detection Server - versiune YOLOv8

# InstaleazÄƒ dependenÈ›ele (ruleazÄƒ o datÄƒ Ã®n Colab)
!pip install ultralytics flask-ngrok flask pillow piexif requests

# Codul serverului
from flask import Flask, request, jsonify
from pyngrok import ngrok
from ultralytics import YOLO
import os

# IniÈ›ializÄƒm aplicaÈ›ia Flask
app = Flask(__name__)

# Calea cÄƒtre modelul YOLOv8
MODEL_PATH = 'yolov5s.pt'  # asigurÄƒ-te cÄƒ fiÈ™ierul e Ã®ncÄƒrcat Ã®n Colab

# ÃncarcÄƒ modelul YOLOv8
print("ğŸ“¦ ÃncÄƒrcare model YOLOv8...")
try:
    model = YOLO(MODEL_PATH)
    print("âœ… Model YOLOv8 Ã®ncÄƒrcat cu succes.")
except Exception as e:
    print(f"âŒ Eroare la Ã®ncÄƒrcarea modelului: {e}")
    model = None

# Endpoint pentru detecÈ›ie
@app.route('/detect', methods=['POST'])
def detect():
    if 'image' not in request.files:
        return jsonify({'status': 'error', 'message': 'Imagine lipsÄƒ.'}), 400

    file = request.files['image']
    img_path = os.path.join('/tmp', file.filename)
    file.save(img_path)

    try:
        # Rulare predicÈ›ie YOLOv8
        results = model.predict(source=img_path, verbose=False)[0]
        # Extrage etichetele detectate
        labels = [model.names[int(c)] for c in results.boxes.cls]

        message = 'Nu s-au detectat gropi.'
        status = 'success'
        if 'pothole' in labels:
            message = 'GroapÄƒ detectatÄƒ.'

        return jsonify({'status': status, 'message': message}), 200

    except Exception as e:
        print(f"âŒ Eroare la detecÈ›ie: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500

# Pornire server cu ngrok
if __name__ == '__main__':
    # AutentificÄƒ ngrok (Ã®nlocuieÈ™te cu token-ul tÄƒu)
    ngrok.set_auth_token('Autothoken')
    public_url = ngrok.connect(5000)
    print(f"ğŸ”— Server public la: {public_url}")
    app.run(port=5000)
